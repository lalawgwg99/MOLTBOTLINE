/* ========== åŸºæœ¬è¨­å®š ========== */
/* ========== ğŸ†• Google Places API è¨­å®š ========== */
var GOOGLE_PLACES_API_KEY = "AIzaSyDOavVgYnquYBIIVuxxM19Xcuv5IbkWk7o";
var SEARCH_RADIUS = 1000; // æœå°‹åŠå¾‘ 1000 å…¬å°º

var CHANNEL_ACCESS_TOKEN = "xXs0zsDZg3IJvJAsfWRo6907MGJinuF2DnTLrRkGegwfEhsilwWiwCEXlxvbKQ0va4oKE+vH1G++w0VqMcFXk1SfJQJZLTzxIJWLOMBku9BE6ZB6wFNl2qhO71yzpKfHKI4nx45wXEa25XlDEviGcwdB04t89/1O/w1cDnyilFU=";
var spreadSheetId = "1bIGh4kVpYvP1PlI_HvLYWOTZAgaKOBJKzobfbl0Bab4";

/* ========== æœå°‹å·¥ä½œè¡¨è¨­å®š ========== */
var sheetName = ["ğŸ“‹å…¨çœè¯çµ¡","ğŸ¤–å®¶é›»MD","2020å¤–é€","2021å¤–é€"];
var searchColumn = [1,1,3,3];

/* ========== å€¼ç­è¡¨è¨­å®š ========== */
var SCHEDULE_SHEET_NAME = "ğŸ“…å®¶é›»ç­è¡¨";
var SCHEDULE_KEYWORDS = ["ç­è¡¨"];
var TOMORROW_KEYWORDS = ["æ˜æ—¥ç­è¡¨"];

/* ========== è·¨åº—æŸ¥è©¢è¨­å®š ========== */
var STORE_QUERY_KEYWORDS = ["æŸ¥è©¢", "è·¨åº—"];

/* ========== ğŸ†• åŠŸèƒ½é¸å–®è¨­å®š ========== */
var MENU_KEYWORDS = ["é¸å–®"];

/* ========== ğŸ†• æ²¹åƒ¹æŸ¥è©¢è¨­å®š ========== */
var OIL_KEYWORDS = ["åŠ æ²¹"];

/* ========== ğŸ†• AI å°è©±è¨­å®š ========== */
var AI_PREFIX = "AI "; // AI å°è©±å¿…é ˆä»¥ "AI " é–‹é ­

/* ========== ğŸ†• ç¾é£Ÿæ¨è–¦è¨­å®š ========== */
var FOOD_KEYWORDS = ["åƒä»€éº¼", "ç¾é£Ÿ", "é¤“é¤“"];
// é¤å»³é¡å‹å°æ‡‰è¡¨
var RESTAURANT_TYPES = {
  "ä¸­å¼æ–™ç†": "chinese_restaurant",
  "æ—¥å¼æ–™ç†": "japanese_restaurant",
  "éŸ“å¼æ–™ç†": "korean_restaurant",
  "ç¾©å¼æ–™ç†": "italian_restaurant",
  "ç¾å¼æ–™ç†": "american_restaurant",
  "æ³°å¼æ–™ç†": "thai_restaurant",
  "å’–å•¡å»³": "cafe",
  "é€Ÿé£Ÿ": "fast_food",
  "ç«é‹": "hot_pot",
  "ç‡’çƒ¤": "barbecue_restaurant"
};

/* ========== ğŸ†• å–®è™ŸæŸ¥è©¢è¨­å®š ========== */
var ORDER_MIN_LENGTH = 8;  // å–®è™Ÿæœ€å°é•·åº¦ï¼ˆé¿å…èª¤è§¸ç™¼çŸ­é—œéµå­—ï¼‰

/* ========== æŒ‰éˆ•é€£çµè¨­å®š ========== */
var OTHER_BUTTON_URL = "https://drive.google.com/file/d/1XIw8ubEFGhbZsRbnrgLs9MIsPTVLpZF5/view?usp=sharing";

/* ========== ç™½åå–®è¨­å®š ========== */
var whiteList = [];
var whiteListMode = 0;

/* ========== æœå°‹æ¨¡å¼ ========== */
var fuzzySearch = 1;

/* ========== UI é…è‰² ========== */
var THEME_COLOR = "#1DB446";
var HEADER_COLOR = "#0F9D58";
var TEXT_COLOR = "#333333";
var SCHEDULE_COLOR = "#FF6F00";
var STORE_COLOR = "#FF5722";
var OIL_COLOR = "#FF9800";
var AI_COLOR = "#2196F3";
var FOOD_COLOR = "#FF6B6B";

/* ========== é¡¯ç¤ºé™åˆ¶ ========== */
var MAX_REPLY_MESSAGES = 5;
var MAX_BUBBLES = 10;
var MAX_FIELDS_PER_BUBBLE = 10;
var MAX_TEXT_LEN = 500;

var spreadSheet = SpreadsheetApp.openById(spreadSheetId);

/**
 * ä¸»è¦è™•ç† POST è«‹æ±‚
 */
function doPost(e) {
  if (!e || !e.postData || !e.postData.contents) {
    return ContentService.createTextOutput("Invalid request");
  }

  var userData;
  try {
    userData = JSON.parse(e.postData.contents);
  } catch (err) {
    Logger.log("JSON parse error: " + err);
    return ContentService.createTextOutput("Bad JSON");
  }

  if (!userData.events || userData.events.length === 0) {
    return ContentService.createTextOutput("No events");
  }

  var event = userData.events[0];

  // ç™½åå–®æª¢æŸ¥
  try {
    var clientID = event.source && event.source.userId ? event.source.userId : null;
    if (whiteListMode === 1) {
      if (!clientID || whiteList.indexOf(clientID) === -1) {
        return ContentService.createTextOutput("Not in whitelist");
      }
    }
  } catch (err) {
    Logger.log("Whitelist check error: " + err);
  }

  var replyToken = event.replyToken;
  var userId = event.source.userId;
  var replyMessage = [];

  // è™•ç†ä½ç½®è¨Šæ¯ï¼ˆç¾é£Ÿæ¨è–¦ï¼‰
  if (event.type === "message" && event.message && event.message.type === "location") {
    handleLocationForFood(event);
    return ContentService.createTextOutput("OK");
  }

  // ==========================================
  // ğŸ†• åœ–ç‰‡è™•ç† (ç¾¤çµ„éœé»˜å¿«å–)
  // ==========================================
  if (event.type === "message" && event.message.type === "image") {
    var userId = event.source.userId;
    var messageId = event.message.id;
    
    // ğŸ’¾ å°‡åœ–ç‰‡ ID å­˜å…¥å¿«å–ï¼Œæœ‰æ•ˆæ™‚é–“ 60 ç§’ (ä»¥ç”¨æˆ¶IDç‚ºKey)
    CacheService.getScriptCache().put(userId + "_last_image", messageId, 60);
    
    // éœé»˜ï¼šç›´æ¥è¿”å› OKï¼Œä¸å›å‚³è¨Šæ¯ï¼Œé¿å…åœ¨ç¾¤çµ„æ´—ç‰ˆ
    return ContentService.createTextOutput("OK");
  }

  // ä¸æ˜¯æ–‡å­—è¨Šæ¯å‰‡çµæŸ (åªå‰©æ–‡å­—è¨Šæ¯éœ€è¦è™•ç†)
  if (event.type !== "message" || !event.message || event.message.type !== "text") {
    return ContentService.createTextOutput("Not a text message");
  }

  var searchContent = (event.message.text || "").trim();

  // ==================================================
  // 1. å„ªå…ˆè™•ç†åœ–ç‰‡åˆ†ææŒ‡ä»¤ (ç¾¤çµ„åœ–ç‰‡å¿«å–è§¸ç™¼ - è¶…ç´šéœé»˜æ¨¡å¼)
  // ==================================================
  var triggerKeywords = ["AI åˆ†æåœ–ç‰‡", "AI çœ‹åœ–", "çœ‹åœ–"];
  if (triggerKeywords.indexOf(searchContent) !== -1) {
    var userId = event.source.userId;
    var cachedMessageId = CacheService.getScriptCache().get(userId + "_last_image");
    
    if (cachedMessageId) {
      // âœ… æ‰¾åˆ°äº†å¿«å–åœ–ç‰‡
      
      // âš ï¸ **é€™è£¡æ•…æ„ç•™ç™½**ï¼šç§»é™¤æ¨æ’­ã€Œåˆ†æä¸­...ã€çš„æŒ‡ä»¤ï¼Œé”æˆçµ•å°éœé»˜ã€‚
      
      var imageBlob = getLineImageBlob(cachedMessageId); 
      var imageBase64 = Utilities.base64Encode(imageBlob.getBytes());
      
      var visionResult = callVisionAI(imageBase64);
      
      replyMessage.push({ type: "text", text: visionResult });
      CacheService.getScriptCache().remove(userId + "_last_image"); 
      
    } else {
      // âŒ æ‰¾ä¸åˆ°åœ–ç‰‡ (è¶…æ™‚æˆ–æ²’å‚³åœ–ï¼Œæ­¤æ™‚å¿…é ˆå›è¦†æç¤º)
      replyMessage.push({ 
        type: "text", 
        text: "âš ï¸ æ‰¾ä¸åˆ°åœ–ç‰‡æˆ–å·²è¶…æ™‚ (60ç§’)ã€‚\n\nè«‹ã€Œå…ˆå‚³é€åœ–ç‰‡ã€ï¼Œç„¶å¾Œé¦¬ä¸Šè¼¸å…¥ã€ŒAI çœ‹åœ–ã€ã€‚" 
      });
    }
    sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
    return ContentService.createTextOutput("OK");
  }
  
  // ğŸ†• è‚¡ç¥¨æŸ¥è©¢å…¥å£ï¼šåªæ¥å—ã€Œè‚¡ç¥¨ï¼‹4~5ä½ä»£ç¢¼ã€
  var stockMatch = searchContent.match(/^è‚¡ç¥¨\s*([0-9]{4,5})$/);
  if (stockMatch) {
    var stockCode = stockMatch[1];
    // å‘¼å«è‚¡ç¥¨åˆ†ææ¨¡çµ„
    if (typeof analyzeAndReply === "function") {
        analyzeAndReply(stockCode, replyToken, userId, "balanced", 1000000);
    } else {
        replyMessage.push({ type: "text", text: "âš ï¸ è‚¡ç¥¨æ¨¡çµ„å°šæœªè¼‰å…¥" });
        sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
    }
    return ContentService.createTextOutput("OK");
  }

  // ========== ğŸ†• æª¢æŸ¥æ˜¯å¦ç‚ºç¾é£Ÿæ¨è–¦ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰ ==========
  var isFoodQuery = false;
  for (var i = 0; i < FOOD_KEYWORDS.length; i++) {
    if (searchContent.toLowerCase() === FOOD_KEYWORDS[i].toLowerCase()) {
      isFoodQuery = true;
      break;
    }
  }

  if (isFoodQuery) {
    handleFoodRecommendation(event);
    return ContentService.createTextOutput("OK");
  }

  // ========== ğŸ†• æª¢æŸ¥æ˜¯å¦ç‚ºé¤å»³é¡å‹é¸æ“‡ ==========
  if (RESTAURANT_TYPES[searchContent]) {
    handleRestaurantType(event, searchContent);
    return ContentService.createTextOutput("OK");
  }

  // ========== ğŸ†• æª¢æŸ¥æ˜¯å¦ç‚ºåŠŸèƒ½é¸å–®ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰ ==========
  var isMenuQuery = false;
  for (var i = 0; i < MENU_KEYWORDS.length; i++) {
    if (searchContent.toLowerCase() === MENU_KEYWORDS[i].toLowerCase()) {
      isMenuQuery = true;
      break;
    }
  }
  
  if (isMenuQuery) {
    replyMessage.push(createFunctionMenu());
    sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
    return ContentService.createTextOutput("OK");
  }

  // ========== ğŸ†• å„ªå…ˆæª¢æŸ¥æ²¹åƒ¹æŸ¥è©¢ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰ ==========
  var isOilQuery = false;
  for (var i = 0; i < OIL_KEYWORDS.length; i++) {
    if (searchContent === OIL_KEYWORDS[i]) {
      isOilQuery = true;
      break;
    }
  }
  
  if (isOilQuery) {
    var oilPriceData = getOilPriceInfo();
    if (oilPriceData.success) {
      replyMessage.push(createOilPriceFlexMessage(oilPriceData));
    } else {
      replyMessage.push({
        type: "text",
        text: "âŒ ç„¡æ³•ç²å–æ²¹åƒ¹è³‡è¨Š\n" + oilPriceData.message
      });
    }
    sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
    return ContentService.createTextOutput("OK");
  }

  // ==================================================
  // 3. è™•ç† AI æ–‡å­—æŒ‡ä»¤ (é›™æ¨¡å‹ PK ç‰ˆ)
  // ==================================================
  if (searchContent.indexOf(AI_PREFIX) === 0) {
    var prompt = searchContent.substring(AI_PREFIX.length).trim();
    if (prompt.length > 0) {
      // 1. å‘¼å«é›™æ¨¡å‹ä¸¦è¡Œè™•ç†
      var aiResults = callDualAIModels(prompt);
      // 2. è£½ä½œå·¦å³æ»‘å‹•çš„ Flex Message
      var flexMsg = createDualAIComparisonFlex(aiResults, prompt);
      // 3. ç™¼é€
      replyMessage.push(flexMsg);
      sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
      return ContentService.createTextOutput("OK");
    }
    return ContentService.createTextOutput("OK");
  }

  // ========== æª¢æŸ¥æ˜¯å¦ç‚ºè·¨åº—æŸ¥è©¢èªªæ˜ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰ ==========
  var isStoreQueryGuide = false;
  for (var i = 0; i < STORE_QUERY_KEYWORDS.length; i++) {
    if (searchContent.toLowerCase() === STORE_QUERY_KEYWORDS[i].toLowerCase()) {
      isStoreQueryGuide = true;
      break;
    }
  }

  if (isStoreQueryGuide) {
    replyMessage.push(createStoreQueryGuide());
    sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
    return ContentService.createTextOutput("OK");
  }

  // ========== æª¢æŸ¥æ˜¯å¦ç‚ºæ˜æ—¥ç­è¡¨æŸ¥è©¢ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰ ==========
  var isTomorrowQuery = false;
  for (var i = 0; i < TOMORROW_KEYWORDS.length; i++) {
    if (searchContent.toLowerCase() === TOMORROW_KEYWORDS[i].toLowerCase()) {
      isTomorrowQuery = true;
      break;
    }
  }

  if (isTomorrowQuery) {
    replyMessage.push(createScheduleMessage(1));
    sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
    return ContentService.createTextOutput("OK");
  }

  // ========== æª¢æŸ¥æ˜¯å¦ç‚ºä»Šæ—¥ç­è¡¨æŸ¥è©¢ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰ ==========
  var isScheduleQuery = false;
  for (var i = 0; i < SCHEDULE_KEYWORDS.length; i++) {
    if (searchContent.toLowerCase() === SCHEDULE_KEYWORDS[i].toLowerCase()) {
      isScheduleQuery = true;
      break;
    }
  }

  if (isScheduleQuery) {
    replyMessage.push(createScheduleMessage(0));
    sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
    return ContentService.createTextOutput("OK");
  }

  // ========== ç©ºç™½æŸ¥è©¢ä¸å›æ‡‰ï¼ˆç¾¤çµ„å…§é¿å…èª¤è§¸ç™¼ï¼‰ ==========
  if (searchContent.length === 0) {
    return ContentService.createTextOutput("OK");
  }

  // ========== æ™ºèƒ½é›™é‡æŸ¥è©¢ï¼šåŒæ™‚æœå°‹å…¨çœè¯çµ¡ + è·¨åº—è²»ç”¨ ==========
  var contactResults = searchContactSheets(searchContent);
  var storeResult = null;
  // å˜—è©¦è·¨åº—æŸ¥è©¢ï¼ˆ2-3å€‹è‹±æ–‡å­—æ¯ï¼‰
  var storeCodePattern = /^[A-Za-z]{2,3}$/;
  if (storeCodePattern.test(searchContent)) {
    storeResult = searchStoreByCode(searchContent.toUpperCase());
  }

  // ========== æ ¹æ“šæŸ¥è©¢çµæœçµ„åˆå›è¦† ==========
  var hasContactResults = contactResults.length > 0;
  var hasStoreResult = storeResult !== null;
  // âœ… å¦‚æœé›»è©±æŸ¥è©¢æœ‰çµæœï¼Œå°±é¡¯ç¤º
  if (hasContactResults || hasStoreResult) {
    if (hasContactResults && !hasStoreResult) {
      // åªæœ‰å…¨çœè¯çµ¡
      if (contactResults.length === 1) {
        replyMessage.push(createFlexMessage(contactResults[0], searchContent));
      } else if (contactResults.length <= MAX_BUBBLES) {
        replyMessage.push(createCarouselMessage(contactResults, searchContent));
      } else {
        replyMessage.push({
          type: "text",
          text: "ğŸ” æ‰¾åˆ° " + contactResults.length + " ç­†ç¬¦åˆã€Œ" + searchContent + "ã€çš„è³‡æ–™\n\n" +
                "ğŸ“‹ ä»¥ä¸‹é¡¯ç¤ºå‰ " + MAX_BUBBLES + " ç­†çµæœ"
        });
        replyMessage.push(createCarouselMessage(contactResults.slice(0, MAX_BUBBLES), searchContent));
      }
    } else if (!hasContactResults && hasStoreResult) {
      // åªæœ‰è·¨åº—è²»ç”¨
      replyMessage.push(createStoreInfoMessage(storeResult, searchContent));
    } else {
      // å…©è€…éƒ½æœ‰ï¼é¡¯ç¤ºå…¨çœè¯çµ¡ + è·¨åº—è²»ç”¨
      if (contactResults.length === 1) {
        replyMessage.push(createFlexMessage(contactResults[0], searchContent));
      } else if (contactResults.length <= 3) {
        replyMessage.push(createCarouselMessage(contactResults, searchContent));
      } else {
        replyMessage.push(createCarouselMessage(contactResults.slice(0, 3), searchContent));
      }
      // å†é¡¯ç¤ºè·¨åº—è²»ç”¨
      replyMessage.push(createStoreInfoMessage(storeResult, searchContent));
    }

    if (replyMessage.length > MAX_REPLY_MESSAGES) {
      replyMessage = replyMessage.slice(0, MAX_REPLY_MESSAGES);
    }

    sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
    return ContentService.createTextOutput("OK");
  }

  // ========== ğŸ†• æœ€å¾Œæ‰åŸ·è¡Œå–®è™ŸæŸ¥è©¢ï¼ˆé•·åº¦ >= 8 ä¸”åŒ…å«è‹±æ–‡ï¼‰ ==========
  if (searchContent.length >= ORDER_MIN_LENGTH) {
    // âœ… å¿…é ˆåŒ…å«è‡³å°‘ 2 å€‹è‹±æ–‡å­—æ¯ï¼ˆé¿å…èª¤åˆ¤ç´”æ•¸å­—é›»è©±ï¼‰
    var hasEnglish = /[A-Za-z]{2,}/.test(searchContent);
    if (hasEnglish) {
      var orderResult = searchOrderNumber(searchContent);
      if (orderResult !== null) {
        replyMessage.push({
          type: "text",
          text: orderResult
        });
        sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, replyMessage);
        return ContentService.createTextOutput("OK");
      }
    }
  }

  // ========== å®Œå…¨æ‰¾ä¸åˆ°ï¼Œä¸å›æ‡‰ï¼ˆé¿å…ç¾¤çµ„å…§å¹²æ“¾ï¼‰ ==========
  return ContentService.createTextOutput("OK");
}
/* ==================================================
   ğŸ†• Gemini 3 Pro
   ================================================== */

/* ========== ğŸ†• AI é›™æ¨¡å‹è¨­å®š ========== */
var API_KEY = "sk-cqRMbQmXfu1cyGCCbGOeufUmXWSF4iWvZ95uaXCaQvMTnP1c"; 
var BASE_URL = "https://www.chataiapi.com/v1"; 

// è¨­å®šè¦é€²è¡Œ PK çš„å…©å€‹æ¨¡å‹
// å»ºè­°æ­é…ï¼šgemini-3-pro-preview (é‚è¼¯å¼·) vs Claude-3.5-Sonnet (æ–‡ç­†å¥½/å¯«ç¨‹å¼å¼·)
var MODEL_A_NAME = "gemini-3-pro-preview"; 
var MODEL_B_NAME = "claude-3-5-sonnet-20240620";
var VISION_MODEL_NAME = "claude-3-5-sonnet-20240620"; // âœ… æ”¹ç”¨ Claude 3.5 Sonnet è™•ç†åœ–ç‰‡

/**
 * 2. é›™æ¨¡å‹ä¸¦è¡Œå‘¼å« (Parallel Execution)
 */
function callDualAIModels(prompt) {
  var url = BASE_URL + "/chat/completions";

  // å…±ç”¨çš„ System Prompt
  var systemPrompt = "è§’è‰²ï¼šå°ç£å°ˆæ¥­é¡§å•èˆ‡è²¼å¿ƒæœ‹å‹ã€‚\n" +
    "ä»»å‹™ï¼šç”¨å°ç£ç¹é«”ä¸­æ–‡å›ç­”ï¼Œå£èªè‡ªç„¶ã€æœ‰æº«åº¦ã€‚\n" +
    "é™åˆ¶ï¼š\n" +
    "1.ã€çµè«–å…ˆè¡Œã€‘ç¬¬ä¸€å¥ç°¡çŸ­è¬›é‡é»ã€‚\n" +
    "2.ã€ç¯‡å¹…ç²¾ç°¡ã€‘ç¸½é•·åº¦æ§åˆ¶åœ¨ 380 å­—ä»¥å…§ï¼Œä¸”æ®µè½åˆ†æ˜ï¼Œé©åˆæ‰‹æ©Ÿå¿«é€Ÿé–±è®€ã€‚\n" +
    "3.ã€æ ¼å¼ç´”æ·¨ã€‘åš´ç¦ä½¿ç”¨ Markdown (å¦‚ **ç²—é«”**, # æ¨™é¡Œ)ï¼Œåƒ…ç”¨ç´”æ–‡å­—ã€Emoji èˆ‡åˆ†æ®µã€‚\n" +
    "4.ã€ä¸»å‹•æŸ¥è­‰ã€‘è‹¥è³‡è¨Šä¸ç¢ºå®šï¼Œå¯ä»¥ä½¿ç”¨å·¥å…·æœå°‹ï¼Œå¦‚æœä¸èƒ½ä¸Šç¶²å°±è«‹ä½ èªªæ˜ï¼Œä¸è¦äº‚ç·¨ã€‚"

  // æº–å‚™å…©å€‹è«‹æ±‚çš„ Payload
  var payloadA = {
    model: MODEL_A_NAME,
    messages: [{ role: "system", content: systemPrompt }, { role: "user", content: prompt }],
    temperature: 0.7
  };

  var payloadB = {
    model: MODEL_B_NAME,
    messages: [{ role: "system", content: systemPrompt }, { role: "user", content: prompt }],
    temperature: 0.7
  };

  // å»ºæ§‹è«‹æ±‚ç‰©ä»¶
  var requestA = {
    url: url,
    method: "post",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY },
    payload: JSON.stringify(payloadA),
    muteHttpExceptions: true
  };

  var requestB = {
    url: url, // ä½¿ç”¨ç›¸åŒçš„ URL
    method: "post",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY },
    payload: JSON.stringify(payloadB),
    muteHttpExceptions: true
  };

  try {
    // ğŸš€ é—œéµæŠ€è¡“ï¼šä½¿ç”¨ fetchAll åŒæ™‚ç™¼å°„å…©å€‹è«‹æ±‚ (çœæ™‚)
    var responses = UrlFetchApp.fetchAll([requestA, requestB]);

    // è§£æçµæœ A
    var resultA = "âŒ ç„¡æ³•å›æ‡‰";
    var jsonA = JSON.parse(responses[0].getContentText());
    if (jsonA.choices && jsonA.choices.length > 0) resultA = jsonA.choices[0].message.content;

    // è§£æçµæœ B
    var resultB = "âŒ ç„¡æ³•å›æ‡‰";
    var jsonB = JSON.parse(responses[1].getContentText());
    if (jsonB.choices && jsonB.choices.length > 0) resultB = jsonB.choices[0].message.content;

    return [
      { model: "ğŸ¤– Gemini-3", content: resultA, color: "#10a37f" }, // OpenAI ç¶ 
      { model: "ğŸ§  Claude 3.5", content: resultB, color: "#da552f" }  // Claude æ©˜
    ];

  } catch (e) {
    Logger.log("é›™æ¨¡å‹éŒ¯èª¤: " + e);
    return [
      { model: MODEL_A_NAME, content: "éŒ¯èª¤: " + e, color: "#999999" },
      { model: MODEL_B_NAME, content: "éŒ¯èª¤: " + e, color: "#999999" }
    ];
  }
}

/**
 * 3. è™•ç†åœ–ç‰‡è¾¨è­˜ (Vision API)
 * å°ˆé–€ç”¨ä¾†å°‡ Base64 åœ–ç‰‡å‚³çµ¦ AI é€²è¡Œåˆ†æ
 */
function callVisionAI(imageBase64) {
  var url = BASE_URL + "/chat/completions";

  // é‡å°ç¾¤çµ„ä½¿ç”¨æƒ…å¢ƒå„ªåŒ–çš„æç¤ºè©
  var promptText = "è«‹ä»¥å½±åƒåˆ†æå°ˆå®¶èº«åˆ†ï¼Œç²¾æº–æ“·å–åœ–ç‰‡ä¸­æ‰€æœ‰æ‰‹å¯«æ–‡å­—èˆ‡å°åˆ·å­—å…ƒï¼Œä¸¦ä»¥é€è¡Œæ–¹å¼å®Œæ•´åˆ—å‡ºåŸæ–‡å…§å®¹ï¼Œæ˜ç¢ºæ¨™ç¤ºæ¯é …æ–‡å­—çš„å­—é«”é¡å‹ï¼ˆæ‰‹å¯«/å°åˆ·ï¼‰ï¼ŒåŒæ™‚é‡é»å½™ç¸½å‹è™Ÿã€åºè™Ÿã€æ•¸å­—ã€æ—¥æœŸèˆ‡å…¶ä»–é—œéµè³‡è¨Šï¼Œæœ€å¾Œæä¾›ä¸€çµ„ã€ŒåŸæ–‡é€è¡Œã€èˆ‡ã€Œé—œéµè³‡è¨Šå½™ç¸½ã€çš„æ•´ç†çµæœã€‚ç”¨å°ç£ç¹é«”ä¸­æ–‡å°ˆæ¥­ä¸”ç°¡çŸ­åœ°å›ç­”ã€‚";

  var payload = {
    model: VISION_MODEL_NAME, 
    messages: [
      {
        role: "user",
        content: [
          { type: "text", text: promptText },
          { type: "image_url", image_url: { url: "data:image/jpeg;base64," + imageBase64 } }
        ]
      }
    ],
    max_tokens: 500
  };

  try {
    var response = UrlFetchApp.fetch(url, {
      method: "post",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });
    
    var data = JSON.parse(response.getContentText());
    if (data.choices && data.choices.length > 0) {
      return "ğŸ‘ï¸ åœ–ç‰‡åˆ†æçµæœï¼š\n\n" + data.choices[0].message.content;
    } else {
      return "âŒ åœ–ç‰‡åˆ†æå¤±æ•—ï¼š" + (data.error ? data.error.message : "æœªçŸ¥éŒ¯èª¤");
    }
  } catch (e) {
    return "âŒ API é€£ç·šéŒ¯èª¤: " + e;
  }
}

/* ğŸ”§ è¼”åŠ©å‡½å¼ (ä¿æŒä¸è®Š) */
function getLineImageBlob(messageId) {
  var url = "https://api-data.line.me/v2/bot/message/" + messageId + "/content";
  var response = UrlFetchApp.fetch(url, { headers: { "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN } });
  return response.getBlob();
}

function pushMessage(userId, msgObj) {
  UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
    method: "post",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN },
    payload: JSON.stringify({ to: userId, messages: [msgObj] })
  });
}

/*==========================================
=            æ²¹åƒ¹æŸ¥è©¢åŠŸèƒ½å€             =
==========================================*/

/**
 * è™•ç†æ²¹åƒ¹æŸ¥è©¢è«‹æ±‚
 */
function handleOilPriceRequest(replyToken) {
  try {
    var oilPriceData = getOilPriceInfo();
    if (oilPriceData.success) {
      var oilPriceFlexMessage = createOilPriceFlexMessage(oilPriceData);
      sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, [oilPriceFlexMessage]);
    } else {
      console.error("æ²¹åƒ¹è³‡è¨Šç²å–å¤±æ•—: " + oilPriceData.message);
      sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, [{type:"text", text:"ç„¡æ³•ç²å–æ²¹åƒ¹è³‡è¨Šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚éŒ¯èª¤: " + oilPriceData.message}]);
    }
  } catch (error) {
    console.error("è™•ç†æ²¹åƒ¹è«‹æ±‚éŒ¯èª¤: " + error);
  }
}

/**
 * ç²å–æ²¹åƒ¹è³‡è¨Š
 */
function getOilPriceInfo() {
  try {
    var url = "https://www.cpc.com.tw/GetOilPriceJson.aspx?type=TodayOilPriceString";
    var options = {
      muteHttpExceptions: true,
      followRedirects: true,
      validateHttpsCertificates: false
    };
    var response = UrlFetchApp.fetch(url, options);
    var responseCode = response.getResponseCode();
    
    if (responseCode !== 200) {
      console.error("ä¸­æ²¹ API å›æ‡‰éŒ¯èª¤: " + responseCode);
      return { success: false, message: "ç„¡æ³•é€£æ¥ä¸­æ²¹è³‡æ–™æœå‹™ (éŒ¯èª¤ä»£ç¢¼: " + responseCode + ")" };
    }
    
    var responseText = response.getContentText();
    var data = JSON.parse(responseText);
    if (!data) {
      return { success: false, message: "ç„¡æ³•ç²å–æ²¹åƒ¹è³‡æ–™" };
    }
    
    var oilPriceInfo = {};
    oilPriceInfo.oil92 = data.sPrice1 || "--";
    oilPriceInfo.oil95 = data.sPrice2 || "--";
    oilPriceInfo.oil98 = data.sPrice3 || "--";
    oilPriceInfo.diesel = data.sPrice4 || "--";
    
    var upDownHtml = data.UpOrDown_Html || "";
    var adjustAmount = "0";
    var adjustDate = data.PriceUpdate || "";
    if (upDownHtml) {
      var directionMatch = upDownHtml.match(/class="sys">([^<]+)<\/b>/i);
      var direction = directionMatch ? directionMatch[1].trim() : "";
      var amountMatch = upDownHtml.match(/class="rate"><i>([^<]+)<\/i>/i);
      var amount = amountMatch ? amountMatch[1].trim() : "0";
      
      adjustAmount = direction.indexOf("èª¿æ¼²") !== -1 ? amount : (direction.indexOf("èª¿é™") !== -1 ? "-" + amount : "0");
    }
    
    oilPriceInfo.adjustDate = adjustDate;
    oilPriceInfo.adjustAmount = adjustAmount;
    var adjustAmountNum = parseFloat(adjustAmount);
    oilPriceInfo.isIncrease = adjustAmountNum > 0;
    oilPriceInfo.isDecrease = adjustAmountNum < 0;
    return {
      success: true,
      oilPriceInfo: oilPriceInfo
    };
  } catch (error) {
    console.error("ç²å–æ²¹åƒ¹è³‡è¨ŠéŒ¯èª¤: " + error);
    return { success: false, message: "è™•ç†æ²¹åƒ¹è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: " + error.toString() };
  }
}

/**
 * å‰µå»ºæ²¹åƒ¹ Flex Message
 */
function createOilPriceFlexMessage(oilPriceData) {
  var oilInfo = oilPriceData.oilPriceInfo;
  var adjustIcon = "â¡ï¸";
  var adjustColor = "#1DB446";
  var adjustText = "æœ¬é€±æ±½æ²¹æŒå¹³";
  if (oilInfo.isIncrease) {
    adjustIcon = "â¬†ï¸";
    adjustColor = "#FF5733";
    adjustText = "æœ¬é€±æ±½æ²¹èª¿æ¼² " + Math.abs(parseFloat(oilInfo.adjustAmount)).toFixed(1);
  } else if (oilInfo.isDecrease) {
    adjustIcon = "â¬‡ï¸";
    adjustColor = "#1DB446";
    adjustText = "æœ¬é€±æ±½æ²¹èª¿é™ " + Math.abs(parseFloat(oilInfo.adjustAmount)).toFixed(1);
  }
  
  var oil92 = oilInfo.oil92 || "--";
  var oil95 = oilInfo.oil95 || "--";
  var oil98 = oilInfo.oil98 || "--";
  var diesel = oilInfo.diesel || "--";
  return {
    "type": "flex",
    "altText": "ä»Šæ—¥æ±½æŸ´æ²¹é›¶å”®åƒ¹æ ¼",
    "contents": {
      "type": "bubble",
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          { "type": "text", "text": "ä»Šæ—¥æ±½æŸ´æ²¹é›¶å”®åƒ¹æ ¼", "weight": "bold", "size": "xl", "align": "center", "color": "#1DB446" },
          { "type": "text", "text": oilInfo.adjustDate ? "è‡ª" + oilInfo.adjustDate + "é›¶æ™‚èµ·å¯¦æ–½" : "æœ€æ–°æ²¹åƒ¹è³‡è¨Š", "size": "sm", "align": "center", "color": "#aaaaaa", "margin": "md" },
          {
            "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm",
            "contents": [
              {
                "type": "box", "layout": "horizontal",
                "contents": [
                  { "type": "text", "text": adjustIcon, "size": "xl", "color": adjustColor, "flex": 0 },
                  { "type": "text", "text": adjustText, "size": "lg", "color": adjustColor, "weight": "bold", "align": "center", "flex": 5 },
                  { "type": "text", "text": Math.abs(parseFloat(oilInfo.adjustAmount)).toFixed(1), "size": "3xl", "color": adjustColor, "weight": "bold", "align": "end", "flex": 3 }
                ]
              },
              { "type": "separator", "margin": "lg" },
              { "type": "box", "layout": "horizontal", "margin": "lg", "contents": [{ "type": "text", "text": "92ç„¡é‰›", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": oil92, "size": "xl", "color": "#111111", "align": "end", "weight": "bold" }] },
              { "type": "box", "layout": "horizontal", "margin": "lg", "contents": [{ "type": "text", "text": "95ç„¡é‰›", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": oil95, "size": "xl", "color": "#111111", "align": "end", "weight": "bold" }] },
              { "type": "box", "layout": "horizontal", "margin": "lg", "contents": [{ "type": "text", "text": "98ç„¡é‰›", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": oil98, "size": "xl", "color": "#111111", "align": "end", "weight": "bold" }] },
              { "type": "box", "layout": "horizontal", "margin": "lg", "contents": [{ "type": "text", "text": "è¶…ç´šæŸ´æ²¹", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": diesel, "size": "xl", "color": "#111111", "align": "end", "weight": "bold" }] },
              { "type": "separator", "margin": "lg" },
              { "type": "box", "layout": "horizontal", "margin": "lg", "contents": [{ "type": "text", "text": "(å–®ä½ï¼šå…ƒ/å…¬å‡)", "size": "xs", "color": "#aaaaaa", "align": "end" }] }
            ]
          }
        ]
      },
      "footer": {
        "type": "box", "layout": "vertical", "spacing": "sm",
        "contents": [
          { "type": "button", "style": "link", "height": "sm", "action": { "type": "uri", "label": "æŸ¥çœ‹æ›´å¤šæ²¹åƒ¹è³‡è¨Š", "uri": "https://www.cpc.com.tw/oilprice.aspx" } },
          { "type": "box", "layout": "vertical", "contents": [], "margin": "sm" },
          { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "è³‡æ–™ä¾†æºï¼šå°ç£ä¸­æ²¹", "color": "#aaaaaa", "size": "xs", "align": "center" }], "margin": "sm" }
        ],
        "flex": 0
      }
    }
  };
}

function testOilPrice() {
  console.log("========== æ¸¬è©¦æ²¹åƒ¹æŸ¥è©¢ ==========");
  var oilData = getOilPriceInfo();
  console.log("æŸ¥è©¢çµæœ: " + JSON.stringify(oilData, null, 2));
  if (oilData.success) {
    console.log("âœ… æ²¹åƒ¹æŸ¥è©¢æˆåŠŸ!");
  } else {
    console.log("âŒ æ²¹åƒ¹æŸ¥è©¢å¤±æ•—: " + oilData.message);
  }
}

/*=====  æ²¹åƒ¹æŸ¥è©¢åŠŸèƒ½å€ çµæŸ  =====*/

/**
 * æœå°‹å…¨çœè¯çµ¡å’Œå®¶é›»MDå·¥ä½œè¡¨
 */
function searchContactSheets(searchContent) {
  var allResults = [];
  for (var i = 0; i < sheetName.length; i++) {
    var sheet = spreadSheet.getSheetByName(sheetName[i]);
    if (!sheet) {
      Logger.log("å·¥ä½œè¡¨ä¸å­˜åœ¨: " + sheetName[i]);
      continue;
    }

    var dataRange = sheet.getDataRange();
    var values = dataRange.getValues();
    if (values.length <= 1) {
      continue;
    }

    var headers = values[0];
    var searchColIndex = searchColumn[i] - 1;

    if (searchColIndex < 0 || searchColIndex >= headers.length) {
      Logger.log("æœå°‹æ¬„ä½è¶…å‡ºç¯„åœ: " + sheetName[i]);
      continue;
    }

    // æœå°‹è³‡æ–™
    for (var row = 1; row < values.length; row++) {
      var cellValue = String(values[row][searchColIndex] || "").trim();
      var isMatch = false;

      if (fuzzySearch === 1) {
        isMatch = cellValue.toLowerCase().indexOf(searchContent.toLowerCase()) !== -1;
      } else {
        isMatch = cellValue.toLowerCase() === searchContent.toLowerCase();
      }

      if (isMatch) {
        var result = {
          sheetName: sheetName[i],
          rowNumber: row + 1,
          data: {}
        };
        for (var col = 0; col < headers.length; col++) {
          result.data[headers[col]] = values[row][col] || "";
        }

        allResults.push(result);
      }
    }
  }

  return allResults;
}

/**
 * å»ºç«‹ç­è¡¨è¨Šæ¯ï¼ˆCarousel ç‰ˆ - ä»Šå¤©/æ˜å¤©/å¾Œå¤©ï¼‰
 */
function createScheduleMessage(daysOffset) {
  var sheet = spreadSheet.getSheetByName(SCHEDULE_SHEET_NAME);
  if (!sheet) {
    return {
      type: "text",
      text: "âŒ æ‰¾ä¸åˆ°ç­è¡¨å·¥ä½œè¡¨ï¼š" + SCHEDULE_SHEET_NAME + "\n\nè«‹ç¢ºèªå·¥ä½œè¡¨åç¨±æ˜¯å¦æ­£ç¢º"
    };
  }

  var values = sheet.getDataRange().getValues();
  if (values.length <= 1) {
    return {
      type: "text",
      text: "âŒ ç­è¡¨å·¥ä½œè¡¨æ˜¯ç©ºçš„\n\nè«‹å…ˆåœ¨ã€Œ" + SCHEDULE_SHEET_NAME + "ã€å·¥ä½œè¡¨ä¸­æ–°å¢è³‡æ–™"
    };
  }

  var headers = values[0];
  var scheduleBubbles = [];
  // ç”Ÿæˆä»Šå¤©ã€æ˜å¤©ã€å¾Œå¤©çš„ç­è¡¨
  for (var dayOffset = 0; dayOffset < 3; dayOffset++) {
    var targetDate = new Date();
    targetDate.setDate(targetDate.getDate() + dayOffset);
    var targetDateStr = Utilities.formatDate(targetDate, "GMT+8", "yyyy-MM-dd");
    var weekday = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][targetDate.getDay()];
    var dateLabel = dayOffset === 0 ? "ä»Šæ—¥" : (dayOffset === 1 ? "æ˜æ—¥" : "å¾Œå¤©");

    var scheduleData = null;
    // æœå°‹å°æ‡‰æ—¥æœŸçš„ç­è¡¨
    for (var row = 1; row < values.length; row++) {
      var dateCell = values[row][0];
      var dateStr = "";
      
      if (dateCell instanceof Date) {
        dateStr = Utilities.formatDate(dateCell, "GMT+8", "yyyy-MM-dd");
      } else {
        dateStr = String(dateCell).trim();
      }

      if (dateStr === targetDateStr) {
        scheduleData = {
          date: dateStr,
          shifts: []
        };
        for (var col = 1; col < headers.length; col++) {
          var timeSlot = headers[col];
          var staff = values[row][col] || "-";
          
          scheduleData.shifts.push({
            time: String(timeSlot),
            staff: String(staff)
          });
        }
        break;
      }
    }

    // å»ºç«‹è©²æ—¥æœŸçš„ Bubble
    if (scheduleData && scheduleData.shifts.length > 0) {
      scheduleBubbles.push(createScheduleBubble(scheduleData, targetDateStr, weekday, dateLabel));
    } else {
      // å¦‚æœæ²’æœ‰ç­è¡¨è³‡æ–™ï¼Œé¡¯ç¤ºç©ºç™½è¨Šæ¯
      scheduleBubbles.push(createEmptyScheduleBubble(targetDateStr, weekday, dateLabel));
    }
  }

  // å¦‚æœæ²’æœ‰ä»»ä½•ç­è¡¨ï¼Œå›å‚³éŒ¯èª¤è¨Šæ¯
  if (scheduleBubbles.length === 0) {
    return {
      type: "text",
      text: "ğŸ“… æœªä¾†ä¸‰å¤©éƒ½æ²’æœ‰ç­è¡¨è³‡æ–™\n\nğŸ’¡ è«‹ç¢ºèªã€Œ" + SCHEDULE_SHEET_NAME + "ã€æ˜¯å¦å·²æ›´æ–°"
    };
  }

  // å›å‚³ Carousel Message
  return {
    type: "flex",
    altText: "ğŸ“… å®¶é›»ç­è¡¨ï¼ˆä»Šå¤©/æ˜å¤©/å¾Œå¤©ï¼‰",
    contents: {
      type: "carousel",
      contents: scheduleBubbles
    }
  };
}

/**
 * å»ºç«‹å–®æ—¥ç­è¡¨ Bubble
 */
function createScheduleBubble(scheduleData, dateStr, weekday, dateLabel) {
  var bodyContents = [];
  // æ¨™é¡Œå€
  bodyContents.push({
    type: "box",
    layout: "vertical",
    contents: [
      { type: "text", text: "ğŸ“… " + dateLabel + "å®¶é›»ç­è¡¨", weight: "bold", size: "xxl", color: SCHEDULE_COLOR, align: "center" },
      { type: "text", text: dateStr + " (æ˜ŸæœŸ" + weekday + ")", size: "md", color: "#666666", align: "center", margin: "sm", weight: "bold" }
    ],
    paddingBottom: "md"
  });
  bodyContents.push({ type: "separator", margin: "md" });

  // ç­è¡¨å…§å®¹
  var shifts = scheduleData.shifts;
  var maxDisplay = 15;

  for (var i = 0; i < Math.min(shifts.length, maxDisplay); i++) {
    var shift = shifts[i];
    bodyContents.push({
      type: "box",
      layout: "vertical",
      margin: "lg",
      spacing: "sm",
      contents: [
        {
          type: "box",
          layout: "horizontal",
          contents: [
            { type: "text", text: "ğŸš©", size: "lg", flex: 0, margin: "none" },
            { type: "text", text: shift.time, size: "lg", color: "#666666", weight: "bold", flex: 1, wrap: true, margin: "sm" }
          ]
        },
        {
          type: "box",
          layout: "horizontal",
          spacing: "sm",
          margin: "sm",
          contents: [
            { type: "text", text: "ğŸ“£", size: "md", flex: 0 },
            { type: "text", text: shift.staff, size: "xl", color: TEXT_COLOR, weight: "bold", flex: 1, wrap: true }
          ]
        },
        { type: "separator", margin: "md" }
      ]
    });
  }

  // ç§»é™¤æœ€å¾Œä¸€å€‹åˆ†éš”ç·š
  if (bodyContents.length > 0) {
    var lastBox = bodyContents[bodyContents.length - 1];
    if (lastBox.contents && lastBox.contents.length > 0) {
      lastBox.contents.pop();
    }
  }

  // å¦‚æœç­è¡¨è¶…éé¡¯ç¤ºä¸Šé™
  if (shifts.length > maxDisplay) {
    bodyContents.push({
      type: "text",
      text: "... é‚„æœ‰ " + (shifts.length - maxDisplay) + " å€‹æ™‚æ®µ",
      size: "sm",
      color: "#999999",
      align: "center",
      margin: "md"
    });
  }

    // Footer æŒ‰éˆ•
  var footerContents = {
    type: "box",
    layout: "vertical",
    spacing: "sm",
    contents: [
      { type: "button", style: "primary", color: SCHEDULE_COLOR, action: { type: "uri", label: "ğŸ”— å®Œæ•´ç­è¡¨", uri: OTHER_BUTTON_URL } },
      { type: "button", style: "link", action: { type: "uri", label: "ğŸ å¥½æ—¥å­", uri: "https://www.goodaytw.com/" }, margin: "sm" }
    ],
    paddingAll: "15px"
  };
  return {
    type: "bubble",
    size: "mega",
    body: { type: "box", layout: "vertical", contents: bodyContents, paddingAll: "20px" },
    footer: footerContents
  };
}

/**
 * å»ºç«‹ç©ºç™½ç­è¡¨ Bubbleï¼ˆç•¶è©²æ—¥æœŸæ²’æœ‰ç­è¡¨æ™‚ï¼‰
 */
function createEmptyScheduleBubble(dateStr, weekday, dateLabel) {
  return {
    type: "bubble",
    size: "mega",
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        { type: "text", text: "ğŸ“… " + dateLabel + "å®¶é›»ç­è¡¨", weight: "bold", size: "xxl", color: SCHEDULE_COLOR, align: "center" },
        { type: "text", text: dateStr + " (æ˜ŸæœŸ" + weekday + ")", size: "md", color: "#666666", align: "center", margin: "sm", weight: "bold" },
        { type: "separator", margin: "lg" },
        {
          type: "box", layout: "vertical", margin: "xl", spacing: "md",
          contents: [
            { type: "text", text: "ğŸ“­", size: "5xl", align: "center", color: "#CCCCCC" },
            { type: "text", text: "å°šç„¡ç­è¡¨è³‡æ–™", size: "lg", color: "#999999", align: "center", weight: "bold", margin: "md" },
            { type: "text", text: "è«‹ç¢ºèªã€Œ" + SCHEDULE_SHEET_NAME + "ã€\næ˜¯å¦å·²æ›´æ–°æ­¤æ—¥æœŸçš„ç­è¡¨", size: "sm", color: "#AAAAAA", align: "center", wrap: true, margin: "md" }
          ]
        }
      ],
      paddingAll: "20px"
    },
    footer: {
      type: "box", layout: "vertical", spacing: "sm",
      contents: [{ type: "button", style: "primary", color: SCHEDULE_COLOR, action: { type: "uri", label: "ğŸ”— å®Œæ•´ç­è¡¨", uri: OTHER_BUTTON_URL } }],
      paddingAll: "15px"
    }
  };
}

function testScheduleCarousel() {
  Logger.log("========== æ¸¬è©¦ç­è¡¨ Carousel ==========");
  var message = createScheduleMessage(0);
  Logger.log("è¨Šæ¯é¡å‹: " + message.type);
  if (message.type === "flex") {
    Logger.log("Carousel å…§å®¹æ•¸é‡: " + message.contents.contents.length);
  } else {
    Logger.log("âš ï¸ å›å‚³æ–‡å­—è¨Šæ¯: " + message.text);
  }
}

/*=====  ç­è¡¨æŸ¥è©¢åŠŸèƒ½å€ çµæŸ  =====*/
/**
 * å»ºç«‹å–®ç­†è³‡æ–™çš„ Flex Messageï¼ˆå«è·¨åº—æŸ¥è©¢æŒ‰éˆ•ï¼‰
 */
function createFlexMessage(result, keyword) {
  var headers = Object.keys(result.data);
  var bodyContents = [];

  bodyContents.push({ type: "text", text: result.sheetName, weight: "bold", size: "xxl", color: HEADER_COLOR, wrap: true });
  bodyContents.push({ type: "separator", margin: "md" });

  var fieldCount = 0;
  for (var i = 0; i < headers.length && fieldCount < MAX_FIELDS_PER_BUBBLE; i++) {
    var key = headers[i];
    var value = String(result.data[key] || "-");

    if (value.length > 150) {
      value = value.substring(0, 147) + "...";
    }

    bodyContents.push({
      type: "box", layout: "vertical", margin: "lg", spacing: "sm",
      contents: [
        { type: "text", text: key, size: "md", color: "#999999", weight: "bold", wrap: true },
        { type: "text", text: value, size: "lg", color: TEXT_COLOR, wrap: true }
      ]
    });

    fieldCount++;
  }

  return {
    type: "flex",
    altText: "âœ… æŸ¥è©¢çµæœï¼š" + keyword,
    contents: {
      type: "bubble",
      size: "mega",
      body: { type: "box", layout: "vertical", contents: bodyContents, paddingAll: "20px" },
      footer: {
        type: "box", layout: "vertical", spacing: "sm",
        contents: [
          { type: "text", text: "ğŸ“ è³‡æ–™ä¾†æºï¼šç¬¬ " + result.rowNumber + " åˆ—", size: "sm", color: "#999999", align: "center", margin: "none" },
          { type: "separator", margin: "md" },
          { type: "button", style: "primary", color: STORE_COLOR, action: { type: "message", label: "åˆ¥æŒ‰æˆ‘..è‡ªå·±è¼¸å…¥è‹±æ–‡åº—å", text: "é¸å–®" }, margin: "md" }
        ],
        paddingAll: "15px"
      }
    }
  };
}

/**
 * å»ºç«‹å¤šç­†è³‡æ–™çš„ Carousel Message
 */
function createCarouselMessage(results, keyword) {
  var bubbles = [];
  for (var i = 0; i < results.length && i < MAX_BUBBLES; i++) {
    var result = results[i];
    var headers = Object.keys(result.data);
    var bodyContents = [];

    bodyContents.push({ type: "text", text: result.sheetName, weight: "bold", size: "xl", color: HEADER_COLOR, wrap: true });
    bodyContents.push({ type: "text", text: "#" + (i + 1), size: "sm", color: "#999999", margin: "xs" });
    bodyContents.push({ type: "separator", margin: "md" });
    
    var fieldCount = 0;
    for (var j = 0; j < headers.length && fieldCount < 5; j++) {
      var key = headers[j];
      var value = String(result.data[key] || "-");

      if (value.length > 60) {
        value = value.substring(0, 57) + "...";
      }

      bodyContents.push({
        type: "box", layout: "vertical", margin: "md", spacing: "xs",
        contents: [
          { type: "text", text: key, size: "sm", color: "#999999", weight: "bold", wrap: true },
          { type: "text", text: value, size: "md", color: TEXT_COLOR, wrap: true }
        ]
      });
      fieldCount++;
    }

    bubbles.push({
      type: "bubble",
      body: { type: "box", layout: "vertical", contents: bodyContents, paddingAll: "18px" },
      footer: {
        type: "box", layout: "vertical", spacing: "sm",
        contents: [{ type: "text", text: "ğŸ“ ç¬¬ " + result.rowNumber + " åˆ—", size: "xs", color: "#999999", align: "center" }],
        paddingAll: "12px"
      }
    });
  }

  return {
    type: "flex",
    altText: "âœ… æ‰¾åˆ° " + results.length + " ç­†çµæœï¼š" + keyword,
    contents: { type: "carousel", contents: bubbles }
  };
}

/**
 * æ ¹æ“šåº—åˆ¥ä»£ç¢¼æœå°‹è·¨å€è²»ç”¨
 */
function searchStoreByCode(storeCode) {
  var allSheets = spreadSheet.getSheets();
  for (var i = 0; i < allSheets.length; i++) {
    var sheetName = allSheets[i].getName();
    if (sheetName.toUpperCase().indexOf(storeCode) !== -1) {
      var targetSheet = allSheets[i];
      var values = targetSheet.getDataRange().getValues();
      if (values.length <= 2) {
        continue;
      }

      var storeInfo = {
        sheetName: sheetName,
        storeName: "",
        fees: []
      };
      if (values[0] && values[0][0]) {
        var firstCell = String(values[0][0]);
        storeInfo.storeName = firstCell;
      }

      for (var row = 2; row < values.length; row++) {
        var fee = values[row][0];
        var area = values[row][1];
        
        if (fee !== "" && area !== "") {
          storeInfo.fees.push({
            fee: String(fee),
            area: String(area)
          });
        }
      }

      if (storeInfo.fees.length > 0) {
        return storeInfo;
      }
    }
  }
  return null;
}

/**
 * å»ºç«‹è·¨åº—æŸ¥è©¢æŒ‡å—
 */
function createStoreQueryGuide() {
  return {
    type: "flex",
    altText: "ğŸª æŸ¥è©¢èªªæ˜",
    contents: {
      type: "bubble",
      body: {
        type: "box", layout: "vertical",
        contents: [
          { type: "text", text: "ğŸª æŸ¥è©¢", weight: "bold", size: "xxl", color: STORE_COLOR, align: "center" },
          { type: "separator", margin: "lg" },
          {
            type: "box", layout: "vertical", margin: "lg", spacing: "md",
            contents: [
              { type: "text", text: "âœ¨âœ¨âœ¨âœ¨âœ¨", size: "lg", color: TEXT_COLOR, weight: "bold", align: "center" },
              { type: "text", text: "è¼¸å…¥åº—åˆ¥ä»£ç¢¼ï¼Œè‡ªå‹•é¡¯ç¤ºï¼š\nâ€¢ å…¨çœè¯çµ¡è³‡æ–™\nâ€¢ è·¨åº—è²»ç”¨è³‡æ–™\nâ€¢ å»ºè­°ä½¿ç”¨ã€Œè‹±æ–‡åº—åã€æŸ¥è©¢\nâ€¢ (*å¦‚éœ€æŸ¥è©¢å®‰è£å®Œå·¥è«‹è¼¸å…¥é›»è©±)", size: "md", color: "#666666", align: "center", margin: "sm", wrap: true }
            ]
          },
          {
            type: "box", layout: "vertical", margin: "lg", spacing: "sm",
            contents: [
              { type: "text", text: "ğŸ’¡ ä½¿ç”¨ç¯„ä¾‹", size: "sm", color: "#999999", weight: "bold" },
              { type: "text", text: "è¼¸å…¥ã€ŒWGã€åŒæ™‚é¡¯ç¤ºè¯çµ¡è³‡æ–™å’Œè·¨å€è²»ç”¨\nâ†’ è¼¸å…¥é›»è©±æŸ¥è©¢éè¡›æ˜ŸçŠ¬å®‰è£å®Œå·¥èˆŠè³‡æ–™", size: "sm", color: TEXT_COLOR, wrap: true }
            ]
          }
        ],
        paddingAll: "20px"
      }
    }
  };
}

/**
 * å»ºç«‹åº—åˆ¥è³‡è¨Šè¨Šæ¯
 */
function createStoreInfoMessage(storeInfo, searchKeyword) {
  var bodyContents = [];
  bodyContents.push({ type: "text", text: "ğŸª è·¨å€è²»ç”¨æŸ¥è©¢", weight: "bold", size: "xxl", color: STORE_COLOR, align: "center" });
  bodyContents.push({ type: "text", text: storeInfo.storeName, size: "lg", color: "#666666", align: "center", margin: "sm", wrap: true });
  bodyContents.push({ type: "text", text: "åº—åˆ¥ä»£ç¢¼ï¼š" + searchKeyword.toUpperCase(), size: "sm", color: "#999999", align: "center", margin: "xs" });
  bodyContents.push({ type: "separator", margin: "lg" });

  var maxDisplay = 12;
  for (var i = 0; i < Math.min(storeInfo.fees.length, maxDisplay); i++) {
    var feeItem = storeInfo.fees[i];
    bodyContents.push({
      type: "box", layout: "vertical", margin: "lg", spacing: "sm",
      contents: [
        {
          type: "box", layout: "horizontal",
          contents: [{ type: "text", text: "ğŸ’°", size: "lg", flex: 0 }, { type: "text", text: feeItem.fee, size: "xl", color: STORE_COLOR, weight: "bold", flex: 1, margin: "sm" }]
        },
        {
          type: "box", layout: "horizontal", spacing: "sm", margin: "sm",
          contents: [{ type: "text", text: "ğŸ“", size: "md", flex: 0 }, { type: "text", text: feeItem.area, size: "md", color: TEXT_COLOR, flex: 1, wrap: true }]
        },
        { type: "separator", margin: "md" }
      ]
    });
  }

  if (bodyContents.length > 0) {
    var lastBox = bodyContents[bodyContents.length - 1];
    if (lastBox.contents && lastBox.contents.length > 0) {
      lastBox.contents.pop();
    }
  }

  if (storeInfo.fees.length > maxDisplay) {
    bodyContents.push({ type: "text", text: "... é‚„æœ‰ " + (storeInfo.fees.length - maxDisplay) + " å€‹å€åŸŸ", size: "sm", color: "#999999", align: "center", margin: "md" });
  }

  return {
    type: "flex",
    altText: "ğŸª " + storeInfo.storeName + " è·¨å€è²»ç”¨",
    contents: {
      type: "bubble", size: "mega",
      body: { type: "box", layout: "vertical", contents: bodyContents, paddingAll: "20px" }
    }
  };
}

/**
 * ç™¼é€å›è¦†è¨Šæ¯
 */
function sendReplyMessage(token, replyToken, messages) {
  var url = "https://api.line.me/v2/bot/message/reply";
  var payload = { replyToken: replyToken, messages: messages };
  var options = {
    method: "post",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  try {
    var response = UrlFetchApp.fetch(url, options);
    var responseCode = response.getResponseCode();
    if (responseCode !== 200) {
      Logger.log("LINE API Error: " + response.getContentText());
    }
  } catch (err) {
    Logger.log("Send message error: " + err);
  }
}

/**
 * æ¸¬è©¦æ™ºèƒ½é›™é‡æŸ¥è©¢
 */
function testSmartQuery() {
  Logger.log("========== æ¸¬è©¦æ™ºèƒ½é›™é‡æŸ¥è©¢ ==========");
  var testKeywords = ["WG", "äº”ç”²", "NZ"];
  for (var i = 0; i < testKeywords.length; i++) {
    var keyword = testKeywords[i];
    Logger.log("\næ¸¬è©¦é—œéµå­—ï¼š" + keyword);
    var contactResults = searchContactSheets(keyword);
    Logger.log("ğŸ“‹ å…¨çœè¯çµ¡ï¼š" + contactResults.length + " ç­†");
    var storeCodePattern = /^[A-Za-z]{2,3}$/;
    if (storeCodePattern.test(keyword)) {
      var storeResult = searchStoreByCode(keyword.toUpperCase());
      if (storeResult) {
        Logger.log("ğŸª è·¨åº—è²»ç”¨ï¼šæ‰¾åˆ° - " + storeResult.storeName);
      } else {
        Logger.log("ğŸª è·¨åº—è²»ç”¨ï¼šæ‰¾ä¸åˆ°");
      }
    } else {
      Logger.log("ğŸª è·¨åº—è²»ç”¨ï¼šä¸ç¬¦åˆåº—åˆ¥ä»£ç¢¼æ ¼å¼");
    }
    Logger.log("---");
  }
}

/**
 * æ¸¬è©¦å®Œæ•´æµç¨‹
 */
function testAll() {
  Logger.log("========== å®Œæ•´æ¸¬è©¦ ==========");
  testSmartQuery();
  Logger.log("\n");
  testOilPrice();
}

/*==========================================
=            åŠŸèƒ½é¸å–®ç³»çµ±             =
==========================================*/

/**
 * å‰µå»ºåŠŸèƒ½é¸å–® Flex Message
 */
function createFunctionMenu() {
  return {
    type: "flex",
    altText: "ğŸ¯ åŠŸèƒ½é¸å–®",
    contents: {
      type: "carousel",
      contents: [
        // ç¬¬ä¸€é ï¼šç­è¡¨æŸ¥è©¢
        {
          type: "bubble", size: "mega",
          header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "ğŸ“… ç­è¡¨æŸ¥è©¢", color: "#ffffff", align: "center", size: "xl", weight: "bold" }], paddingAll: "20px", backgroundColor: SCHEDULE_COLOR, spacing: "md", height: "80px", paddingTop: "22px" },
          body: {
            type: "box", layout: "vertical",
            contents: [
              { type: "text", text: "æŸ¥è©¢å®¶é›»éƒ¨é–€ç­è¡¨", color: "#666666", size: "sm", wrap: true, align: "center" },
              { type: "separator", margin: "lg" },
              { type: "box", layout: "vertical", margin: "lg", spacing: "md", contents: [{ type: "text", text: "ğŸ“Œ ä½¿ç”¨èªªæ˜", size: "md", weight: "bold", color: SCHEDULE_COLOR }, { type: "text", text: "â€¢ è¼¸å…¥ ç­è¡¨ã€‚\nâ€¢ æœƒè‡ªå‹•é¡¯ç¤ºè¿‘3æ—¥ç­è¡¨", size: "sm", color: "#666666", wrap: true, margin: "sm" }] }
            ],
            spacing: "md", paddingAll: "20px"
          },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "button", style: "primary", height: "sm", action: { type: "message", label: "ğŸ“… ç­è¡¨", text: "ç­è¡¨" }, color: SCHEDULE_COLOR }], flex: 0, paddingAll: "15px" }
        },
        // ç¬¬äºŒé ï¼šåº—åˆ¥æŸ¥è©¢
        {
          type: "bubble", size: "mega",
          header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "ğŸª åº—åˆ¥æŸ¥è©¢", color: "#ffffff", align: "center", size: "xl", weight: "bold" }], paddingAll: "20px", backgroundColor: STORE_COLOR, spacing: "md", height: "80px", paddingTop: "22px" },
          body: {
            type: "box", layout: "vertical",
            contents: [
              { type: "text", text: "æŸ¥è©¢å„åº—è¯çµ¡è³‡æ–™èˆ‡è·¨åº—è²»ç”¨", color: "#666666", size: "sm", wrap: true, align: "center" },
              { type: "separator", margin: "lg" },
              { type: "box", layout: "vertical", margin: "lg", spacing: "md", contents: [{ type: "text", text: "ğŸ“Œ ä½¿ç”¨èªªæ˜", size: "md", weight: "bold", color: STORE_COLOR }, { type: "text", text: "â€¢ è¼¸å…¥åº—åˆ¥ä»£ç¢¼ï¼ˆå¦‚ï¼šWGã€NZï¼‰\nâ€¢ è‡ªå‹•é¡¯ç¤ºè¯çµ¡è³‡æ–™å’Œè·¨åº—è²»ç”¨", size: "sm", color: "#666666", wrap: true, margin: "sm" }] },
              { type: "box", layout: "vertical", margin: "lg", spacing: "sm", contents: [{ type: "text", text: "ğŸ’¡ ç¯„ä¾‹", size: "sm", weight: "bold", color: "#999999" }, { type: "text", text: "è¼¸å…¥è‹±æ–‡ä»£ç¢¼ã€ŒWGã€", size: "xs", color: "#999999", margin: "xs" }] }
            ],
            spacing: "md", paddingAll: "20px"
          },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "button", style: "primary", height: "sm", action: { type: "message", label: "ğŸ“– ä¸è¦æŒ‰", text: "WG" }, color: STORE_COLOR }], flex: 0, paddingAll: "15px" }
        },
        // ç¬¬ä¸‰é ï¼šMDè³‡æ–™æŸ¥è©¢
        {
          type: "bubble", size: "mega",
          header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "ğŸ¤– MDè³‡æ–™æŸ¥è©¢", color: "#ffffff", align: "center", size: "xl", weight: "bold" }], paddingAll: "20px", backgroundColor: THEME_COLOR, spacing: "md", height: "80px", paddingTop: "22px" },
          body: {
            type: "box", layout: "vertical",
            contents: [
              { type: "text", text: "æŸ¥è©¢å®¶é›»MDè¯çµ¡è³‡æ–™", color: "#666666", size: "sm", wrap: true, align: "center" },
              { type: "separator", margin: "lg" },
              { type: "box", layout: "vertical", margin: "lg", spacing: "md", contents: [{ type: "text", text: "ğŸ“Œ ä½¿ç”¨èªªæ˜", size: "md", weight: "bold", color: THEME_COLOR }, { type: "text", text: "â€¢ è¼¸å…¥éƒ¨é–€+MD\nâ€¢ ç³»çµ±æœƒæœå°‹ã€ŒğŸ¤–å®¶é›»MDã€å·¥ä½œè¡¨", size: "sm", color: "#666666", wrap: true, margin: "sm" }] },
              { type: "box", layout: "vertical", margin: "lg", spacing: "sm", contents: [{ type: "text", text: "ğŸ’¡ ç¯„ä¾‹", size: "sm", weight: "bold", color: "#999999" }, { type: "text", text: "è¼¸å…¥ã€Œ40MDã€æˆ–ã€Œ49MDã€", size: "xs", color: "#999999", margin: "xs" }] }
            ],
            spacing: "md", paddingAll: "20px"
          },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "text", text: "ç›´æ¥è¼¸å…¥é—œéµå­—å³å¯æŸ¥è©¢", size: "xs", color: "#999999", align: "center" }], flex: 0, paddingAll: "15px" }
        },
        // ç¬¬å››é ï¼šAIåŠ©æ‰‹ (å·²æ›´æ–°æè¿°)
        {
          type: "bubble", size: "mega",
          header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "ğŸ¤– AI æ™ºèƒ½åŠ©æ‰‹", color: "#ffffff", align: "center", size: "xl", weight: "bold" }], paddingAll: "20px", backgroundColor: AI_COLOR, spacing: "md", height: "80px", paddingTop: "22px" },
          body: {
            type: "box", layout: "vertical",
            contents: [
              { type: "text", text: "Gemini 3 Pro", color: "#666666", size: "sm", wrap: true, align: "center" },
              { type: "separator", margin: "lg" },
              {
                type: "box", layout: "vertical", margin: "lg", spacing: "md",
                contents: [
                  { type: "text", text: "ğŸ“Œ ä½¿ç”¨èªªæ˜", size: "md", weight: "bold", color: AI_COLOR },
                  { type: "text", text: "â€¢ è¼¸å…¥ã€ŒAI + å•é¡Œã€: æ–‡å­—å•ç­”\n", size: "sm", color: "#666666", wrap: true, margin: "sm" }
                ]
              },
              { type: "box", layout: "vertical", margin: "lg", spacing: "sm", contents: [{ type: "text", text: "ğŸ’¡ ç¯„ä¾‹", size: "sm", weight: "bold", color: "#999999" }, { type: "text", text: "AI ä½ å¥½\nAI è­˜åˆ¥ (ç„¶å¾Œå‚³åœ–)\nAI ç•« ä¸€éš»è²“", size: "xs", color: "#999999", margin: "xs" }] }
            ],
            spacing: "md", paddingAll: "20px"
          },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "button", style: "primary", height: "sm", action: { type: "message", label: "ğŸ¤– è©¦è©¦çœ‹", text: "AI ä½ å¥½" }, color: AI_COLOR }], flex: 0, paddingAll: "15px" }
        },
        // ç¬¬äº”é :æ²¹åƒ¹æŸ¥è©¢
        {
          type: "bubble", size: "mega",
          header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "â›½ ä»Šæ—¥æ²¹åƒ¹", color: "#ffffff", align: "center", size: "xl", weight: "bold" }], paddingAll: "20px", backgroundColor: OIL_COLOR, spacing: "md", height: "80px", paddingTop: "22px" },
          body: {
            type: "box", layout: "vertical",
            contents: [
              { type: "text", text: "æŸ¥è©¢å°ç£ä¸­æ²¹æœ€æ–°æ²¹åƒ¹", color: "#666666", size: "sm", wrap: true, align: "center" },
              { type: "separator", margin: "lg" },
              { type: "box", layout: "vertical", margin: "lg", spacing: "md", contents: [{ type: "text", text: "ğŸ“Œ ä½¿ç”¨èªªæ˜", size: "md", weight: "bold", color: OIL_COLOR }, { type: "text", text: "â€¢ è¼¸å…¥ã€ŒåŠ æ²¹ã€å³å¯æŸ¥è©¢\nâ€¢ é¡¯ç¤º92/95/98ç„¡é‰›æ±½æ²¹\nâ€¢ é¡¯ç¤ºè¶…ç´šæŸ´æ²¹åƒ¹æ ¼\nâ€¢ é¡¯ç¤ºæœ¬é€±èª¿æ¼²/èª¿é™è³‡è¨Š", size: "sm", color: "#666666", wrap: true, margin: "sm" }] },
              { type: "box", layout: "vertical", margin: "lg", spacing: "sm", contents: [{ type: "text", text: "ğŸ’¡ è³‡æ–™ä¾†æº", size: "sm", weight: "bold", color: "#999999" }, { type: "text", text: "å¾·ä¸­æ²¹å®˜æ–¹å³æ™‚è³‡æ–™", size: "xs", color: "#999999", margin: "xs" }] }
            ],
            spacing: "md", paddingAll: "20px"
          },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "button", style: "primary", height: "sm", action: { type: "message", label: "â›½ æŸ¥è©¢æ²¹åƒ¹", text: "åŠ æ²¹" }, color: OIL_COLOR }], flex: 0, paddingAll: "15px" }
        },
        // ç¬¬å…­é ï¼šå®¶é›»å®‰è£é‹è²»
        {
          type: "bubble", size: "mega",
          header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "ğŸšš å®‰è£é‹è²»", color: "#ffffff", align: "center", size: "xl", weight: "bold" }], paddingAll: "20px", backgroundColor: "#FF6B35", spacing: "md", height: "80px", paddingTop: "22px" },
          body: {
            type: "box", layout: "vertical",
            contents: [
              { type: "text", text: "å®¶é›»å®‰è£èˆ‡é‹é€è²»ç”¨", color: "#666666", size: "sm", wrap: true, align: "center" },
              { type: "separator", margin: "lg" },
              { type: "box", layout: "vertical", margin: "lg", spacing: "md", contents: [{ type: "text", text: "ğŸ“Œ ä½¿ç”¨èªªæ˜", size: "md", weight: "bold", color: "#FF6B35" }, { type: "text", text: "â€¢ è¼¸å…¥ã€Œé‹è²»ã€\nâ€¢ ç³»çµ±æœƒè·³å‡ºæ”¶è²»è¡¨åœ–ç‰‡", size: "sm", color: "#666666", wrap: true, margin: "sm" }] },
              { type: "box", layout: "vertical", margin: "lg", spacing: "sm", contents: [{ type: "text", text: "ğŸ’¡ ç¯„ä¾‹", size: "sm", weight: "bold", color: "#999999" }, { type: "text", text: "è¼¸å…¥ã€Œé‹è²»ã€", size: "xs", color: "#999999", margin: "xs" }] }
            ],
            spacing: "md", paddingAll: "20px"
          },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "button", style: "primary", height: "sm", action: { type: "message", label: "ğŸ“‹ æŸ¥çœ‹è²»ç”¨", text: "é‹è²»" }, color: "#FF6B35" }], flex: 0, paddingAll: "15px" }
        },
        // ç¬¬ä¸ƒé ï¼šç¾é£Ÿæ¨è–¦
        {
          type: "bubble", size: "mega",
          header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "ğŸ½ï¸ ç¾é£Ÿæ¨è–¦", color: "#ffffff", align: "center", size: "xl", weight: "bold" }], paddingAll: "20px", backgroundColor: FOOD_COLOR, spacing: "md", height: "80px", paddingTop: "22px" },
          body: {
            type: "box", layout: "vertical",
            contents: [
              { type: "text", text: "ç”¨å®šä½å¹«ä½ æ‰¾é™„è¿‘é¤å»³", color: "#666666", size: "sm", wrap: true, align: "center" },
              { type: "separator", margin: "lg" },
              { type: "box", layout: "vertical", margin: "lg", spacing: "md", contents: [{ type: "text", text: "ğŸ“Œ ä½¿ç”¨èªªæ˜", size: "md", weight: "bold", color: FOOD_COLOR }, { type: "text", text: "â€¢ è¼¸å…¥ï¼šç¾é£Ÿ æˆ– é¤“é¤“\nâ€¢ å…¨çƒä»»ä½•ä½ç½®éƒ½èƒ½å®šä½\nâ€¢ å†é¸æ“‡æ–™ç†é¡å‹ï¼šä¸­å¼æ–™ç†ã€æ—¥å¼æ–™ç†ã€ç«é‹â€¦", size: "sm", color: "#666666", wrap: true, margin: "sm" }] }
            ],
            spacing: "md", paddingAll: "20px"
          },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "button", style: "primary", height: "sm", action: { type: "message", label: "ğŸ½ï¸ æˆ‘é¤“äº†", text: "åƒä»€éº¼" }, color: FOOD_COLOR }], flex: 0, paddingAll: "15px" }
        },
        // ç¬¬å…«é ï¼šè‚¡ç¥¨æŸ¥è©¢
        {
          type: "bubble", size: "mega",
          header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "ğŸ“Š è‚¡ç¥¨æŸ¥è©¢", color: "#ffffff", align: "center", size: "xl", weight: "bold" }], paddingAll: "20px", backgroundColor: "#673AB7", spacing: "md", height: "80px", paddingTop: "22px" },
          body: {
            type: "box", layout: "vertical",
            contents: [
              { type: "text", text: "æŸ¥è©¢å°è‚¡æŠ€è¡“é¢èˆ‡åŸºæœ¬é¢", color: "#666666", size: "sm", wrap: true, align: "center" },
              { type: "separator", margin: "lg" },
              { type: "box", layout: "vertical", margin: "lg", spacing: "md", contents: [{ type: "text", text: "ğŸ“Œ ä½¿ç”¨èªªæ˜", size: "md", weight: "bold", color: "#673AB7" }, { type: "text", text: "â€¢ è¼¸å…¥ï¼šè‚¡ç¥¨ï¼‹è‚¡ç¥¨ä»£ç¢¼\nâ€¢ ä¾‹ï¼šè‚¡ç¥¨2330ã€è‚¡ç¥¨ 0050\nâ€¢ é¡¯ç¤ºæŠ€è¡“æŒ‡æ¨™ã€åŸºæœ¬é¢ã€æ³•äººç±Œç¢¼èˆ‡æ–°èâ€¢ æ•¸å€¼ç‚ºè­‰äº¤æ‰€+FinMind,å¯èƒ½å»¶é²éæœ€æ–°", size: "sm", color: "#666666", wrap: true, margin: "sm" }] }
            ],
            spacing: "md", paddingAll: "20px"
          },
          footer: { type: "box", layout: "vertical", spacing: "sm", contents: [{ type: "button", style: "primary", height: "sm", action: { type: "message", label: "ğŸ“Š æŸ¥å°ç©é›»", text: "è‚¡ç¥¨2330" }, color: "#673AB7" }], flex: 0, paddingAll: "15px" }
        }
      ]
    }
  };
}

/**
 * æ¸¬è©¦åŠŸèƒ½é¸å–®
 */
function testMenu() {
  Logger.log("========== æ¸¬è©¦åŠŸèƒ½é¸å–® ==========");
  var menu = createFunctionMenu();
  Logger.log("é¸å–®é¡å‹: " + menu.type);
  Logger.log("é¸å–®å…§å®¹: " + JSON.stringify(menu.contents, null, 2));
  Logger.log("âœ… åŠŸèƒ½é¸å–®å‰µå»ºæˆåŠŸ!");
}

/*=====  åŠŸèƒ½é¸å–®ç³»çµ± çµæŸ  =====*/

/*==========================================
=            å–®è™ŸæŸ¥è©¢åŠŸèƒ½å€             =
==========================================*/

/**
 * æŸ¥è©¢å–®è™Ÿè³‡è¨Šï¼ˆæ”¯æ´å¤šåˆ†é ï¼‰
 */
function searchOrderNumber(orderNumber) {
  var ss = SpreadsheetApp.openById(spreadSheetId);
  var sheets = ss.getSheets();
  var results = [];
  
  // éæ­·æ‰€æœ‰åˆ†é 
  for (var i = 0; i < sheets.length; i++) {
    var sheet = sheets[i];
    var sheetName = sheet.getName();
    
    // è·³éç³»çµ±å·¥ä½œè¡¨
    if (sheetName.indexOf("ğŸ“‹") !== -1 || 
        sheetName.indexOf("ğŸ¤–") !== -1 || 
        sheetName.indexOf("ğŸ“…") !== -1) {
      continue;
    }
    
    var data = sheet.getDataRange().getValues();
    // æœå°‹å–®è™Ÿï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
    for (var row = 0; row < data.length; row++) {
      for (var col = 0; col < data[row].length; col++) {
        var cellValue = String(data[row][col]).trim().toUpperCase();
        var searchValue = orderNumber.toUpperCase();
        
        if (cellValue === searchValue) {
          var result = extractOrderInfo(sheet, data, row, sheetName);
          if (result) {
            results.push(result);
          }
          break;
        }
      }
    }
  }
  
  // æ‰¾ä¸åˆ°å°±å›å‚³ nullï¼ˆä¸å›æ‡‰ï¼‰
  if (results.length === 0) {
    return null;
  }
  
  return formatOrderResults(results, orderNumber);
}

/**
 * æå–è¨‚å–®è³‡è¨Š
 */
function extractOrderInfo(sheet, data, row, sheetName) {
  try {
    var date = extractDateFromData(data, row);
    // æå–è² è²¬äººå“¡
    var staff = "";
    for (var col = 0; col < Math.min(data[row].length, 5); col++) {
      var cellValue = String(data[row][col]).trim();
      if (cellValue && cellValue.length < 20 && cellValue.length > 0) {
        if (!/\d{8,}/.test(cellValue)) {  // æ’é™¤é•·æ•¸å­—
          staff = cellValue;
          break;
        }
      }
    }
    
    // æå–å–®è™Ÿ
    var orderNum = "";
    for (var col = 0; col < data[row].length; col++) {
      var cellValue = String(data[row][col]).trim();
      if (cellValue.length >= 8 && /[A-Z]{2,}/.test(cellValue.toUpperCase())) {
        orderNum = cellValue;
        break;
      }
    }
    
    // æå–å•†å“å’Œé‡‘é¡
    var products = [];
    for (var col = 0; col < data[row].length; col++) {
      var cellValue = data[row][col];
      if (!isNaN(cellValue) && cellValue !== "" && cellValue > 0) {
        var numValue = Number(cellValue);
        if (numValue >= 100) {
          if (data[0] && data[0][col]) {
            var productName = String(data[0][col]).trim();
            if (productName && productName !== "é‡‘é¡" && productName !== "åˆè¨ˆ") {
              products.push(productName + ": $" + numValue);
            }
          }
        }
      }
    }
    
    return {
      date: date,
      staff: staff || "æœªçŸ¥",
      orderNumber: orderNum,
      products: products.length > 0 ? products.join("\n") : "ç„¡å•†å“è³‡è¨Š",
      sheetName: sheetName
    };
  } catch (err) {
    Logger.log("æå–è¨‚å–®è³‡è¨ŠéŒ¯èª¤: " + err);
    return null;
  }
}

/**
 * å¾è³‡æ–™ä¸­æå–æ—¥æœŸ
 */
function extractDateFromData(data, targetRow) {
  for (var row = targetRow; row >= 0; row--) {
    for (var col = 0; col < data[row].length; col++) {
      var cellValue = String(data[row][col]);
      if (cellValue.match(/\d{4}\/\d{1,2}\/\d{1,2}/)) {
        return cellValue.match(/\d{4}\/\d{1,2}\/\d{1,2}/)[0];
      }
    }
  }
  return "æœªçŸ¥æ—¥æœŸ";
}

/**
 * æ ¼å¼åŒ–æŸ¥è©¢çµæœ
 */
function formatOrderResults(results, orderNumber) {
  var message = "ğŸ” å–®è™ŸæŸ¥è©¢çµæœ\n";
  message += "â”â”â”â”â”â”â”â”â”\n\n";
  results.forEach(function(result, index) {
    if (index > 0) {
      message += "\n\n\n";
    }
    message += "ğŸ“‹ å–®è™Ÿï¼š" + result.orderNumber + "\n";
    message += "ğŸ‘¤ è² è²¬äººå“¡ï¼š" + result.staff + "\n";
    message += "ğŸ“‚ ä¾†æºï¼š" + result.sheetName;
  });
  return message;
}

/**
 * æ¸¬è©¦å–®è™ŸæŸ¥è©¢
 */
function testOrderSearch() {
  Logger.log("========== æ¸¬è©¦å–®è™ŸæŸ¥è©¢ ==========");
  var testOrders = ["WG2508170018", "NZ2508160052", "ä¸å­˜åœ¨çš„å–®è™Ÿ"];
  testOrders.forEach(function(orderNum) {
    Logger.log("\næŸ¥è©¢å–®è™Ÿ: " + orderNum);
    var result = searchOrderNumber(orderNum);
    if (result !== null) {
      Logger.log(result);
    } else {
      Logger.log("âŒ æŸ¥ç„¡æ­¤å–®è™Ÿï¼ˆä¸å›æ‡‰ï¼‰");
    }
    Logger.log("---");
  });
}

/*=====  å–®è™ŸæŸ¥è©¢åŠŸèƒ½å€ çµæŸ  =====*/

/*==========================================
=            ğŸ†• ç¾é£Ÿæ¨è–¦åŠŸèƒ½å€             =
==========================================*/

/**
 * è™•ç†ç¾é£Ÿæ¨è–¦è«‹æ±‚ - å…ˆé¸æ“‡é¡å‹
 */
function handleFoodRecommendation(event) {
  var replyToken = event.replyToken;
  var message = {
    type: "text",
    text: "ğŸ½ï¸ é¸æ“‡é¤å»³é¡å‹ï¼Œæˆ–ç›´æ¥åˆ†äº«ä½ç½®éš¨æ©Ÿæ¨è–¦ ğŸ‘‡",
    quickReply: {
      items: [
        { type: "action", action: { type: "message", label: "ğŸ¥¢ ä¸­å¼æ–™ç†", text: "ä¸­å¼æ–™ç†" } },
        { type: "action", action: { type: "message", label: "ğŸ£ æ—¥å¼æ–™ç†", text: "æ—¥å¼æ–™ç†" } },
        { type: "action", action: { type: "message", label: "ğŸœ éŸ“å¼æ–™ç†", text: "éŸ“å¼æ–™ç†" } },
        { type: "action", action: { type: "message", label: "ğŸ ç¾©å¼æ–™ç†", text: "ç¾©å¼æ–™ç†" } },
        { type: "action", action: { type: "message", label: "ğŸ” ç¾å¼æ–™ç†", text: "ç¾å¼æ–™ç†" } },
        { type: "action", action: { type: "message", label: "ğŸŒ¶ï¸æ³°å¼æ–™ç†", text: "æ³°å¼æ–™ç†" } },
        { type: "action", action: { type: "message", label: "â˜• å’–å•¡å»³", text: "å’–å•¡å»³" } },
        { type: "action", action: { type: "message", label: "ğŸŸ é€Ÿé£Ÿ", text: "é€Ÿé£Ÿ" } },
        { type: "action", action: { type: "message", label: "ğŸ² ç«é‹", text: "ç«é‹" } },
        { type: "action", action: { type: "message", label: "ğŸ¥© ç‡’çƒ¤", text: "ç‡’çƒ¤" } },
        { type: "action", action: { type: "location", label: "ğŸ“ éš¨æ©Ÿæ¨è–¦" } }
      ]
    }
  };
  sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, [message]);
}

/**
 * è™•ç†é¤å»³é¡å‹é¸æ“‡
 */
function handleRestaurantType(event, restaurantType) {
  var replyToken = event.replyToken;
  var userId = event.source.userId;
  // å„²å­˜ç”¨æˆ¶é¸æ“‡çš„é¤å»³é¡å‹
  var userProperties = PropertiesService.getUserProperties();
  userProperties.setProperty(userId + "_restaurant_type", restaurantType);
  var message = {
    type: "text",
    text: "ğŸ‘ å¥½çš„ï¼æœå°‹" + restaurantType + "\n\nè«‹ç¢ºèªä½ çš„ä½ç½® ğŸ“",
    quickReply: {
      items: [
        { type: "action", action: { type: "location", label: "ğŸ“ åˆ†äº«ä½ç½®(æŸ¥æ‰¾åŠå¾‘ç¯„åœ1000M)" } }
      ]
    }
  };
  sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, [message]);
}

/**
 * è™•ç†ä½ç½®è¨Šæ¯ï¼Œæœå°‹é™„è¿‘é¤å»³
 */
function handleLocationForFood(event) {
  var replyToken = event.replyToken;
  var userId = event.source.userId;
  var latitude = event.message.latitude;
  var longitude = event.message.longitude;
  
  // å–å¾—ç”¨æˆ¶é¸æ“‡çš„é¤å»³é¡å‹
  var userProperties = PropertiesService.getUserProperties();
  var selectedType = userProperties.getProperty(userId + "_restaurant_type");
  
  // æœå°‹é™„è¿‘é¤å»³
  var restaurants = searchNearbyRestaurants(latitude, longitude, SEARCH_RADIUS, selectedType);
  // æ¸…é™¤å·²å„²å­˜çš„é¡å‹
  userProperties.deleteProperty(userId + "_restaurant_type");
  
  if (restaurants.length === 0) {
    var message = {
      type: "text",
      text: "ğŸ˜… æŠ±æ­‰ï¼Œé™„è¿‘æ‰¾ä¸åˆ°" + (selectedType ? selectedType : "é¤å»³") + "è³‡è¨Š\n\nè«‹è©¦è©¦å…¶ä»–é¡å‹æˆ–ä½ç½®"
    };
    sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, [message]);
    return;
  }
  
  // å–å‰ 5 é–“é¤å»³
  var topRestaurants = restaurants.slice(0, Math.min(9, restaurants.length));
  // å»ºç«‹è¼ªæ’­å¡ç‰‡
  var carouselMessage = createRestaurantCarousel(topRestaurants, latitude, longitude);
  
  sendReplyMessage(CHANNEL_ACCESS_TOKEN, replyToken, [carouselMessage]);
}

/**
 * ä½¿ç”¨ Google Places API æœå°‹é™„è¿‘é¤å»³
 */
function searchNearbyRestaurants(latitude, longitude, radius, restaurantType) {
  var url = "https://maps.googleapis.com/maps/api/place/nearbysearch/json";
  var params = {
    location: latitude + "," + longitude,
    radius: radius,
    language: "zh-TW",
    key: GOOGLE_PLACES_API_KEY
  };
  if (restaurantType && RESTAURANT_TYPES[restaurantType]) {
    params.type = "restaurant";
    params.keyword = restaurantType;
  } else {
    params.type = "restaurant";
  }
  
  var queryString = Object.keys(params).map(function(key) {
    return key + "=" + encodeURIComponent(params[key]);
  }).join("&");
  var response = UrlFetchApp.fetch(url + "?" + queryString);
  var data = JSON.parse(response.getContentText());
  if (data.status === "OK") {
    return data.results.sort(function(a, b) {
      return (b.rating || 0) - (a.rating || 0);
    });
  } else {
    Logger.log("Google Places API Error: " + data.status);
    return [];
  }
}

/**
 * å–å¾—é¤å»³è©³ç´°è³‡è¨Š
 */
function getRestaurantDetails(placeId) {
  var url = "https://maps.googleapis.com/maps/api/place/details/json";
  var params = {
    place_id: placeId,
    fields: "name,rating,formatted_phone_number,opening_hours,price_level,photos,geometry,formatted_address",
    language: "zh-TW",
    key: GOOGLE_PLACES_API_KEY
  };
  var queryString = Object.keys(params).map(function(key) {
    return key + "=" + encodeURIComponent(params[key]);
  }).join("&");
  var response = UrlFetchApp.fetch(url + "?" + queryString);
  var data = JSON.parse(response.getContentText());
  if (data.status === "OK") {
    return data.result;
  } else {
    Logger.log("Google Places API Error: " + data.status);
    return null;
  }
}

/**
 * å–å¾—é¤å»³ç…§ç‰‡ URL
 */
function getPhotoUrl(photoReference, maxWidth) {
  maxWidth = maxWidth || 400;
  if (!photoReference) {
    return "https://via.placeholder.com/400x300/FF6B6B/FFFFFF?text=No+Image";
  }
  
  return "https://maps.googleapis.com/maps/api/place/photo?maxwidth=" + maxWidth + 
         "&photo_reference=" + photoReference + 
         "&key=" + GOOGLE_PLACES_API_KEY;
}

/**
 * è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢ï¼ˆå…¬å°ºï¼‰
 */
function calculateDistance(lat1, lng1, lat2, lng2) {
  var R = 6371000;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLng / 2) * Math.sin(dLng / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  var distance = R * c;
  
  return Math.round(distance);
}

/**
 * æ ¼å¼åŒ–è·é›¢é¡¯ç¤º
 */
function formatDistance(meters) {
  if (meters < 1000) {
    return meters + " å…¬å°º";
  } else {
    return (meters / 1000).toFixed(1) + " å…¬é‡Œ";
  }
}

/**
 * å–å¾—ä»Šæ—¥ç‡Ÿæ¥­æ™‚é–“
 */
function getTodayOpeningHours(openingHours) {
  if (!openingHours || !openingHours.weekday_text) {
    return "ç‡Ÿæ¥­æ™‚é–“æœªæä¾›";
  }
  
  var today = new Date().getDay();
  var index = today === 0 ? 6 : today - 1;
  var todayHours = openingHours.weekday_text[index];
  
  if (todayHours) {
    todayHours = todayHours.replace(/^[^:]+:\s*/, "");
  }
  
  return todayHours || "ç‡Ÿæ¥­æ™‚é–“æœªæä¾›";
}

/**
 * å»ºç«‹é¤å»³è¼ªæ’­ Carousel Message
 */
function createRestaurantCarousel(restaurants, userLat, userLng) {
  var bubbles = [];
  for (var i = 0; i < restaurants.length; i++) {
    var restaurant = restaurants[i];
    var bubble = createRestaurantBubble(restaurant, userLat, userLng);
    bubbles.push(bubble);
  }
  
  return {
    type: "flex",
    altText: "ğŸ½ï¸ ç‚ºä½ æ¨è–¦ " + restaurants.length + " é–“é¤å»³",
    contents: {
      type: "carousel",
      contents: bubbles
    }
  };
}

/**
 * å»ºç«‹å–®ä¸€é¤å»³ Bubble
 */
function createRestaurantBubble(restaurant, userLat, userLng) {
  var name = restaurant.name || "æœªçŸ¥é¤å»³";
  var rating = restaurant.rating || 0;
  var address = restaurant.vicinity || "åœ°å€æœªæä¾›";
  var placeId = restaurant.place_id;
  
  var lat = restaurant.geometry.location.lat;
  var lng = restaurant.geometry.location.lng;
  var distance = calculateDistance(userLat, userLng, lat, lng);
  var distanceText = formatDistance(distance);
  
  var details = getRestaurantDetails(placeId);
  var phone = details && details.formatted_phone_number ? details.formatted_phone_number : "é›»è©±æœªæä¾›";
  var isOpen = details && details.opening_hours ? details.opening_hours.open_now : null;
  var priceLevel = details && details.price_level ? details.price_level : 0;
  var openingHours = details && details.opening_hours ? getTodayOpeningHours(details.opening_hours) : "ç‡Ÿæ¥­æ™‚é–“æœªæä¾›";
  var openStatus = "";
  var openStatusColor = "#999999";
  if (isOpen === true) {
    openStatus = "ğŸŸ¢ ç‡Ÿæ¥­ä¸­";
    openStatusColor = "#06C755";
  } else if (isOpen === false) {
    openStatus = "ğŸ”´ å·²æ‰“çƒŠ";
    openStatusColor = "#FF0000";
  } else {
    openStatus = "â“ ç‡Ÿæ¥­è³‡è¨Šæœªæä¾›";
  }
  
  var priceText = "";
  for (var i = 0; i < priceLevel; i++) {
    priceText += "ğŸ’°";
  }
  if (priceText === "") {
    priceText = "åƒ¹æ ¼æœªæä¾›";
  }
  
  var photoUrl = "https://via.placeholder.com/400x300/FF6B6B/FFFFFF?text=No+Image";
  if (restaurant.photos && restaurant.photos.length > 0) {
    photoUrl = getPhotoUrl(restaurant.photos[0].photo_reference, 400);
  }
  
  var mapsUrl = "https://www.google.com/maps/search/?api=1&query=" + lat + "," + lng + "&query_place_id=" + placeId;
  var ratingStars = "";
  var fullStars = Math.floor(rating);
  for (var i = 0; i < fullStars; i++) {
    ratingStars += "â­";
  }
  if (rating % 1 >= 0.5) {
    ratingStars += "âœ¨";
  }
  
  var bubble = {
    type: "bubble",
    size: "mega",
    hero: {
      type: "image",
      url: photoUrl,
      size: "full",
      aspectRatio: "20:13",
      aspectMode: "cover",
      action: { type: "uri", uri: mapsUrl }
    },
    body: {
      type: "box", layout: "vertical",
      contents: [
        { type: "text", text: name, weight: "bold", size: "xl", wrap: true, maxLines: 2 },
        {
          type: "box", layout: "baseline", margin: "md",
          contents: [
            { type: "text", text: ratingStars + " " + rating.toFixed(1), size: "sm", color: FOOD_COLOR, flex: 0, weight: "bold" },
            { type: "text", text: openStatus, size: "sm", color: openStatusColor, margin: "md", weight: "bold", flex: 0 }
          ]
        },
        {
          type: "box", layout: "baseline", margin: "sm",
          contents: [{ type: "text", text: "ğŸ“ " + distanceText, size: "xs", color: "#8c8c8c", flex: 0 }]
        },
        {
          type: "box", layout: "vertical", margin: "lg", spacing: "sm",
          contents: [
            {
              type: "box", layout: "baseline", spacing: "sm",
              contents: [{ type: "text", text: "â°", color: "#aaaaaa", size: "sm", flex: 1 }, { type: "text", text: openingHours, wrap: true, color: "#666666", size: "sm", flex: 5 }]
            },
            {
              type: "box", layout: "baseline", spacing: "sm",
              contents: [{ type: "text", text: "ğŸ’°", color: "#aaaaaa", size: "sm", flex: 1 }, { type: "text", text: priceText, wrap: true, color: "#666666", size: "sm", flex: 5 }]
            },
            {
              type: "box", layout: "baseline", spacing: "sm",
              contents: [{ type: "text", text: "ğŸ“", color: "#aaaaaa", size: "sm", flex: 1 }, { type: "text", text: address, wrap: true, color: "#666666", size: "sm", flex: 5, maxLines: 2 }]
            },
            {
              type: "box", layout: "baseline", spacing: "sm",
              contents: [
                { type: "text", text: "ğŸ“", color: "#aaaaaa", size: "sm", flex: 1 },
                {
                  type: "text", text: phone, wrap: true, color: "#666666", size: "sm", flex: 5,
                  action: phone !== "é›»è©±æœªæä¾›" ? { type: "uri", uri: "tel:" + phone.replace(/[^0-9+]/g, "") } : undefined
                }
              ]
            }
          ]
        }
      ]
    },
    footer: {
      type: "box", layout: "vertical", spacing: "sm",
      contents: [
        { type: "button", style: "primary", height: "sm", color: FOOD_COLOR, action: { type: "uri", label: "ğŸ—ºï¸ æŸ¥çœ‹åœ°åœ–", uri: mapsUrl } },
        { type: "button", style: "link", height: "sm", action: { type: "message", label: "ğŸ”„ é‡æ–°æ¨è–¦", text: "åƒä»€éº¼" } }
      ],
      flex: 0
    }
  };
  return bubble;
}

/*=====  ç¾é£Ÿæ¨è–¦åŠŸèƒ½å€ çµæŸ  =====*/

/**
 * å»ºç«‹é›™æ¨¡å‹æ¯”è¼ƒ Carousel
 */
function createDualAIComparisonFlex(results, prompt) {
  var bubbles = [];

  // éæ­·å…©å€‹æ¨¡å‹çš„çµæœï¼Œè£½ä½œå…©å€‹ Bubble
  for (var i = 0; i < results.length; i++) {
    var item = results[i];
    
    bubbles.push({
      type: "bubble",
      size: "mega",
      header: {
        type: "box",
        layout: "vertical",
        contents: [
          { type: "text", text: item.model, color: "#ffffff", weight: "bold", size: "xl" }
        ],
        backgroundColor: item.color,
        paddingAll: "15px"
      },
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          // é¡¯ç¤ºç”¨æˆ¶çš„å•é¡Œ (å°å­—)
          { type: "text", text: "Q: " + prompt, size: "xs", color: "#aaaaaa", wrap: true, maxLines: 2 },
          { type: "separator", margin: "md" },
          // é¡¯ç¤º AI å›ç­”
          { type: "text", text: item.content, size: "sm", color: "#333333", wrap: true, margin: "md" }
        ],
        paddingAll: "20px"
      }
    });
  }

  return {
    type: "flex",
    altText: "ğŸ¤– æ™ºèƒ½é›™æ¨¡å‹ï¼š" + prompt,
    contents: {
      type: "carousel", // è¨­å®šç‚ºè¼ªæ’­æ ¼å¼
      contents: bubbles
    }
  };
}